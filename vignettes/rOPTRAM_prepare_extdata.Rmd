---
title: "rOPTRAM: Deriving Soil Moisture from Sentinel-2 Imagery"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{rOPTRAM-1}
  %\VignetteEngine{knitr::rmarkdown_notangle}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{tmap}
bibliography: "references.bib"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  comment = "#>"
)
```

### Prerequisites

```{r setup, results='hide'}
remotes::install_gitlab("rsl-bidr/roptram")
library(rOPTRAM)
if (!require("CDSE")) install.packages("CDSE", dependencies = TRUE)
if (!require("jsonlite")) install.packages("jsonlite", dependencies = TRUE)
```

### Main wrapper function

```{r wrapper, warning=FALSE, message=FALSE}
from_date <- "2021-10-01"
to_date <- "2023-04-30"
output_dir <- "/home/micha/work/BIDR/Soil_Moisture/Israel/Migda/Migda9"
aoi_file <- system.file("extdata", "migda9.gpkg", package = "rOPTRAM")
veg_index <- "SAVI"
coeffs <- optram(aoi_file,
                 from_date, to_date,
                 veg_index = veg_index,
                 S2_output_dir = output_dir,
                 data_output_dir = output_dir,
                 remote = "scihub")
knitr::kable(coeffs, caption = "Trapezoid coefficients")
```
### Show trapezoid plots

#### Prepare data.frame of pixel values

```{r prepare, warning=FALSE, message=FALSE, results='hide'}
s2_file_list <- optram_acquire_s2(aoi_file,
                            from_date, to_date,
                            output_dir = output_dir,
                            veg_index =veg_index,
                            remote = "scihub")
STR_list <- list.files(file.path(output_dir, "STR"),
                      pattern = ".tif$", full.names = TRUE)
VI_list <- list.files(file.path(output_dir, "SAVI"),
                      pattern = ".tif$", full.names = TRUE)
full_df <- optram_ndvi_str(STR_list, VI_list,
                           output_dir = output_dir,
                           rm.low.vi = TRUE, rm.hi.str = TRUE)
```

#### Linear fit

```{r plot-linear, fig.cap="Trapezoid scatterplot", out.width = '90%', warning=FALSE}
ttl <- "Migda"
meth <- "linear"
coeffs <- optram_wetdry_coefficients(full_df,
                                     aoi_file = aoi_file,
                                     output_dir = output_dir,
                                     trapezoid_method = meth,
                                     save_plot = FALSE)
plot_vi_str_cloud(full_df, coeffs, ttl,
                  output_dir = output_dir,
                  trapezoid_method = meth,
                  edges_points = TRUE)
knitr::include_graphics(file.path(output_dir,
                                  "trapezoid_Migda_linear.png"))
```

#### Exponential fit

```{r plot-exp, fig.cap="Exponential fit trapezoid scatterplot", out.width = '90%', warning=FALSE}
ttl <- "Migda"
meth <- "exponential"
coeffs <- optram_wetdry_coefficients(full_df,
                                     aoi_file = aoi_file,
                                     output_dir = output_dir,
                                     trapezoid_method = meth,
                                     save_plot = FALSE)
plot_vi_str_cloud(full_df, coeffs, ttl,
                  output_dir = output_dir,
                  trapezoid_method = meth,
                  edges_points = TRUE)
knitr::include_graphics(file.path(output_dir,
                                  "trapezoid_Migda_exponential.png"))
```

#### Polynomial fitted trapezoid plot

```{r plot-poly, fig.cap="Polynomial fit trapezoid scatterplot", out.width = '90%', warning=FALSE}
ttl <- "Migda"
meth <- "polynomial"
coeffs <- optram_wetdry_coefficients(full_df,
                                     aoi_file = aoi_file,
                                     output_dir = output_dir,
                                     trapezoid_method = meth,
                                     save_plot = FALSE)
plot_vi_str_cloud(full_df, coeffs, ttl,
                  output_dir = output_dir,
                  trapezoid_method = meth,
                  edges_points = TRUE)
knitr::include_graphics(file.path(output_dir,
                                  "trapezoid_Migda_polynomial.png"))
```


